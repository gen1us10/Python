{% extends "base.html" %}
{% block title %}Мої транзакції{% endblock %}
{% block content %}
<h1 class="h4 mb-3">Мої транзакції</h1>

<form class="row g-2 mb-3">
  <div class="col-auto"><input name="q" class="form-control" placeholder="Пошук..." value="{{ request.GET.q }}"></div>
  <div class="col-auto"><input name="day" type="date" class="form-control" value="{{ request.GET.day }}"></div>
  <div class="col-auto">
    <select name="table" class="form-select">
      <option value="">Всі таблиці</option>
      {% for t in tables %}
        <option value="{{ t.id }}" {% if request.GET.table == t.id|stringformat:'s' %}selected{% endif %}>{{ t.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto"><button class="btn btn-outline-primary">Фільтр</button></div>
  <div class="col-auto"><a class="btn btn-success" href="{% url 'finances:transaction_create' %}">Додати</a></div>
</form>

<div class="mb-3">
  <strong>Суми за валютами:</strong>
  {% for row in totals_by_currency %}
    <span class="badge bg-secondary">{{ row.total }} {{ row.currency }}</span>
  {% empty %}
    <em>Немає даних</em>
  {% endfor %}

  <a class="btn btn-sm btn-outline-dark ms-2"
     href="{% url 'api:convert_totals_to_uah' %}">
    Показати в UAH (API)
  </a>
</div>

<table class="table table-striped">
  <thead>
    <tr><th>Дата</th><th>Назва</th><th>Сума</th><th>Категорії</th><th>Таблиця</th><th></th></tr>
  </thead>
  <tbody>
    {% for tx in object_list %}
      <tr>
        <td>{{ tx.date }}</td>
        <td>{{ tx.title }}</td>
        <td>{{ tx.amount }} {{ tx.currency }}</td>
        <td>
          {% for c in tx.categories.all %}
            <span class="badge bg-light text-dark">{{ c.name }}</span>
          {% empty %}
            -
          {% endfor %}
        </td>
        <td>{{ tx.table.name }}</td>
        <td>
          <a class="btn btn-sm btn-outline-primary" href="{% url 'finances:transaction_update' tx.pk %}">Edit</a>
          <a class="btn btn-sm btn-outline-danger" href="{% url 'finances:transaction_delete' tx.pk %}">Delete</a>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="6"><em>Поки що порожньо</em></td></tr>
    {% endfor %}
  </tbody>
</table>

<hr class="my-4">
<h2 class="h5 mb-3">Середні витрати за категоріями (в UAH)</h2>
<canvas id="catAvgChart" height="120"></canvas>
<small class="text-muted d-block mt-2" id="chartNote"></small>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function () {
  const note = document.getElementById('chartNote');
  const ctx = document.getElementById('catAvgChart').getContext('2d');

  try {
    const resp = await fetch("{% url 'api:avg_by_category' %}", {credentials: 'same-origin'});
    if (!resp.ok) {
      note.textContent = 'Не вдалося завантажити дані для графіка (потрібен вхід, або помилка API).';
      return;
    }

    const raw = await resp.json(); // [{categories__name, currency, avg_amount}]
    const onlyUAH = raw.filter(r => r.currency === 'UAH');

    if (!onlyUAH.length) {
      note.textContent = 'Немає даних у валюті UAH для побудови графіка (додайте транзакції в UAH).';
      return;
    }

    const map = new Map();
    for (const row of onlyUAH) {
      const cat = row.categories__name || 'Без категорії';
      const prev = map.get(cat) || [];
      prev.push(Number(row.avg_amount) || 0);
      map.set(cat, prev);
    }

    const labels = [];
    const data = [];
    for (const [cat, arr] of map.entries()) {
      const avg = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
      labels.push(cat);
      data.push(Number(avg.toFixed(2)));
    }

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Середні витрати (UAH)',
          data,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  } catch (e) {
    console.error(e);
    note.textContent = 'Помилка побудови графіка.';
  }
})();
</script>
{% endblock %}
